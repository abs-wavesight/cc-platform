name: 'Build and Publish Func App with Dynamic Config'

on:
  workflow_call:
    inputs:
      tagVersion:
         required: true
         type: string
         description: 'Solution tag'
      solutionName:
        required: true
        type: string
        description: 'Solution file'
      solutionDirectory:
        required: true
        type: string
        description: 'Solution file path'
      dotnetVersion:
        required: true
        type: string 
        description: '.NET SDK Version'     
      artifactConfigName:
        required: true
        type: string
        description: 'Specifies the name of the artifact containing builded functions'
      artifactConfigFile:
        required: true
        type: string
        description: 'Specifies the file name in the artifact containing configuration'
      artifactOutput:
        required: true
        type: string
        description: 'Specifies the name of the artifact containing builded functions'  
    secrets:
      GH_PAT:
        required: false
env:
  NUGET_PACKAGE_PATH: ${{ github.workspace }}/.nuget/packages  
  
jobs:
  build_and_publish:
    runs-on: windows-2019
    steps:
      - name: 'Checkout GitHub Action'
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || ' ' }}

      - name: Cache nuget packages
        uses: actions/cache@v3
        with:
          path: ${{ env.NUGET_PACKAGE_PATH }}
          key: ${{ runner.OS }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: ${{ runner.OS }}-nuget-

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ inputs.dotnetVersion }}

      - name: Restore dependencies
        working-directory: ${{ inputs.solutionDirectory }}
        run: dotnet restore ${{ inputs.solutionName }} --packages ${{ env.NUGET_PACKAGE_PATH }}
      

      - name: 'Build the Project'
        working-directory: ${{ inputs.solutionDirectory }}
        run: dotnet build ${{ inputs.solutionName }} --configuration Release --no-restore

      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.artifactConfigName }}
          path: downloaded-artifacts/      

      - name: Publish
        working-directory: ${{ inputs.solutionDirectory }}
        shell: pwsh
        run: |
          $artifactPath = Join-Path -Path "${{ github.workspace }}/downloaded-artifacts" -ChildPath "${{ inputs.artifactConfigFile }}"
          $functionConfigs = Get-Content $artifactPath | ConvertFrom-Json
          $artifactOutputDir = "${{ github.workspace }}/artifacts"
          New-Item -ItemType Directory -Force -Path $artifactOutputDir
          foreach ($config in $functionConfigs) {            
               $functionPack  = Join-Path $config.FUNCTION_PROJECT_PATH "publish" 
               dotnet publish $config.FUNCTION_PROJECT_PATH --configuration Release --no-build --output $functionPack  
               
               $hostJsonPath = Join-Path -Path $functionPack -ChildPath "host.json"
               $hostJson = Get-Content $hostJsonPath | ConvertFrom-Json
               $hostJson.version = "${{ github.event.inputs.tagVersion }}"
               $hostJson | ConvertTo-Json | Set-Content $hostJsonPath
               
               $zipFilePath = Join-Path $artifactOutputDir "$($config.Name).zip" 
               Compress-Archive -Path "$($functionPack)\*" -DestinationPath $zipFilePath
               Write-Host "Zipped $($config.Name) function app to: $zipFilePath"            
          }
          $zipFileName = "${{ inputs.artifactOutput }}.zip"
          $zipFilePath = Join-Path -Path "${{ github.workspace }}" -ChildPath $zipFileName
          Compress-Archive -Path "$artifactOutputDir\artifacts\*" -DestinationPath $zipFilePath
          Write-Host "Created zip: $zipFilePath"
          echo "ZIP_FILE=$zipFileName" >> $GITHUB_ENV


      - name: Publish to GitHub Release
        uses: ncipollo/release-action@v1
        with:
            allowUpdates: true
            body: "---"
            tag: ${{ inputs.tagVersion }}
            commit: ${{ github.sha }}
            name: Release ${{ inputs.tagVersion }}
            artifacts: ${{ github.workspace }}/${{ env.ZIP_FILE }}              

      - name: Tag current build
        run: |
            git config --global user.name 'github-actions'
            git config --global user.email 'github-actions@github.com'
            git tag ${{ inputs.tagVersion }}
            git push origin ${{ inputs.tagVersion }}
        shell: pwsh
  
          
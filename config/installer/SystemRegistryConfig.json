{
  "location": "$ABS_PATH\\installer",
  "components": [
    {
      "name": "Installer",
      "files": [],
      "actions": [
        {
          "source": "Installer.exe",
          "destination": "$ABS_PATH\\Installer.exe",
          "action": "copy"
        },
        {
          "source": "Uninstall.cmd",
          "destination": "$ABS_PATH\\Uninstall.cmd",
          "action": "copy"
        }
      ]
    },
    {
      "name": "Certificates-Central",
      "files": [],
      "actions": [
        {
          "source": "..\\AdditionalFiles\\central-rabbitmq.key",
          "destination": "$ABS_PATH\\certificates\\local-keys\\rabbitmq.key",
          "action": "copy"
        },
        {
          "source": "..\\AdditionalFiles\\central-rabbitmq.cer",
          "destination": "$ABS_PATH\\certificates\\local-certs\\rabbitmq.cer",
          "action": "copy"
        },
        {
          "source": "..\\AdditionalFiles\\central-rabbitmq.pem",
          "destination": "$ABS_PATH\\certificates\\local-certs\\rabbitmq.pem",
          "action": "copy"
        },
        {
          "source": "certutil.exe -addstore root \"$ABS_PATH\\certificates\\local-certs\\rabbitmq.cer\"",
          "action": "execute"
        }
      ]
    },
    {
      "name": "Docker",
      "files": [
        {
          "type": "file",
          "source": "https://download.docker.com/win/static/stable/x86_64/docker-24.0.4.zip",
          "destination": "docker.zip"
        },
        {
          "type": "file",
          "source": "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-windows-x86_64.exe",
          "destination": "docker-compose.exe"
        },
        {
          "type": "file",
          "source": "https://raw.githubusercontent.com/abs-wavesight/cc-platform/main/compose/installer/docker-compose.root.yml",
          "destination": "docker-compose.root.yml"
        },
        {
          "type": "file",
          "source": "https://raw.githubusercontent.com/abs-wavesight/cc-platform/main/compose/installer/environment.env",
          "destination": "environment.env"
        }
      ],
      "actions": [
        {
          "source": "net stop dockerd",
          "action": "executeImmediate"
        },
        {
          "source": "tar -xf docker.zip -C c:\\",
          "action": "executeImmediate"
        },
        {
          "source": "docker-compose.exe",
          "destination": "c:\\docker\\docker-compose.exe",
          "action": "copy"
        },
        {
          "source": "powershell -Command Enable-WindowsOptionalFeature -Online -FeatureName Containers -All -NoRestart",
          "action": "executeImmediate"
        },
        {
          "source": "c:\\docker\\dockerd --service-name dockerd --register-service",
          "action": "executeImmediate"
        },
        {
          "source": "net start dockerd",
          "action": "executeImmediate"
        },
        {
          "source": "powershell -Command \"docker stop $(docker ps -a -q)\"",
          "action": "executeImmediate"
        },
        {
          "source": "powershell -Command \"docker rm $(docker ps -a -q)\"",
          "action": "executeImmediate"
        },
        {
          "source": "c:\\docker\\docker system prune -f",
          "action": "executeImmediate"
        },
        {
          "source": "c:\\docker\\docker volume prune -f",
          "action": "executeImmediate"
        },
        {
          "source": "c:\\docker\\docker network prune -f",
          "action": "executeImmediate"
        },
        {
          "source": "c:\\docker",
          "action": "updatePath"
        },
        {
          "source": "docker-compose.root.yml",
          "destination": "$ABS_PATH\\config\\docker-compose.root.yml",
          "action": "copy"
        },
        {
          "source": "$ABS_PATH\\config\\docker-compose.root.yml",
          "action": "replaceParameters"
        },
        {
          "source": "environment.env",
          "destination": "$ABS_PATH\\config\\environment.env",
          "action": "copy"
        },
        {
          "source": "$ABS_PATH\\config\\environment.env",
          "action": "replaceParameters"
        },
        {
          "source": "$ABS_PATH\\config",
          "action": "runDockerCompose"
        }
      ]
    },
    {
      "name": "OpenSsl",
      "files": [
        {
          "type": "release",
          "source": "https://github.com/abs-wavesight/cc-platform/releases/download/$OPENSSL_RELEASE_TAG/",
          "destination": "c:/abs/temp/OpenSsl/"
        }
      ],
      "actions": [
        {
          "source": "openssl.tar",
          "action": "install"
        },
        {
          "source": "generate-certs-prod.ps1",
          "destination": "$ABS_PATH\\config\\openssl\\generate-certs-prod.ps1",
          "action": "copy"
        },
        {
          "source": "openssl-prod.cnf",
          "destination": "$ABS_PATH\\config\\openssl\\openssl-prod.cnf",
          "action": "copy"
        },
        {
          "source": "manual-docker-compose.openssl.yml",
          "destination": "$ABS_PATH\\config\\manual-docker-compose.openssl.yml",
          "action": "copy"
        },
        {
          "source": "$ABS_PATH\\config\\manual-docker-compose.openssl.yml",
          "action": "replaceParameters"
        },
        {
          "source": "powershell -Command [System.IO.Directory]::CreateDirectory('$ABS_PATH/certificates/local-keys')",
          "action": "executeImmediate"
        },
        {
          "source": "powershell -Command [System.IO.Directory]::CreateDirectory('$ABS_PATH/certificates/local-certs')",
          "action": "executeImmediate"
        },
        {
          "source": "powershell -Command [System.IO.Directory]::CreateDirectory('$ABS_PATH/certificates/remote-certs')",
          "action": "executeImmediate"
        },
        {
          "source": "..\\AdditionalFiles\\central-rabbitmq.cer",
          "destination": "$ABS_PATH\\certificates\\remote-certs\\rabbitmq.cer",
          "action": "copy"
        },
        {
          "source": "..\\AdditionalFiles\\central-rabbitmq.pem",
          "destination": "$ABS_PATH\\certificates\\remote-certs\\rabbitmq.pem",
          "action": "copy"
        },
        {
          "source": "powershell -Command \"docker-compose -f \"$ABS_PATH/config/manual-docker-compose.openssl.yml\" up --exit-code-from cc.openssl-generate-certs\"",
          "action": "execute"
        },
        {
          "source": "certutil.exe -addstore root \"$ABS_PATH\\certificates\\local-certs\\rabbitmq.cer\"",
          "action": "execute"
        },
        {
          "source": "certutil.exe -addstore root \"$ABS_PATH\\certificates\\remote-certs\\rabbitmq.cer\"",
          "action": "execute"
        }
      ]
    },
    {
      "name": "RabbitMq",
      "files": [
        {
          "type": "release",
          "source": "https://github.com/abs-wavesight/cc-platform/releases/download/$RABBIT_RELEASE_TAG/",
          "destination": "c:/abs/temp/RabbitMq/"
        }
      ],
      "actions": [
        {
          "source": "rabbitmq.tar",
          "action": "install"
        },
        {
          "source": "cc-rabbitmq.conf",
          "destination": "$ABS_PATH\\config\\rabbitmq\\cc-rabbitmq.conf",
          "action": "copy"
        },
        {
          "source": "docker-compose.rabbitmq.yml",
          "destination": "$ABS_PATH\\config\\docker-compose.rabbitmq.yml",
          "action": "copy"
        },
        {
          "source": "local.definitions.json",
          "destination": "$ABS_PATH\\config\\rabbitmq\\definitions\\local\\local.definitions.json",
          "action": "copy"
        },
        {
          "source": "remote.definitions.json",
          "destination": "$ABS_PATH\\config\\rabbitmq\\definitions\\remote\\remote.definitions.json",
          "action": "copy"
        },
        {
          "source": "$ABS_PATH\\config\\docker-compose.rabbitmq.yml",
          "action": "replaceParameters"
        }
      ]
    },
    {
      "name": "Vector-Site",
      "files": [
        {
          "type": "release",
          "source": "https://github.com/abs-wavesight/cc-platform/releases/download/$VECTOR_SITE_RELEASE_TAG/",
          "destination": "c:/abs/temp/Vector-Site/"
        }
      ],
      "actions": [
        {
          "source": "vector.tar",
          "action": "install"
        },
        {
          "source": "vector.toml",
          "destination": "$ABS_PATH\\config\\vector\\vector.toml",
          "action": "copy"
        },
        {
          "source": "remap-container-logs.vrl",
          "destination": "$ABS_PATH\\config\\vector\\remap-container-logs.vrl",
          "action": "copy"
        },
        {
          "source": "docker-compose.vector.yml",
          "destination": "$ABS_PATH\\config\\docker-compose.vector.yml",
          "action": "copy"
        },
        {
          "source": "$ABS_PATH\\config\\docker-compose.vector.yml",
          "action": "replaceParameters"
        },
        {
          "source": "powershell -Command [System.IO.Directory]::CreateDirectory('$ABS_PATH/logs')",
          "action": "execute"
        }
      ]
    },
    {
      "name": "Vector-Central",
      "files": [
        {
          "type": "release",
          "source": "https://github.com/abs-wavesight/cc-platform/releases/download/$VECTOR_CENTRAL_RELEASE_TAG/",
          "destination": "c:/abs/temp/Vector-Central/"
        }
      ],
      "actions": [
        {
          "source": "vector.tar",
          "action": "install"
        },
        {
          "source": "vector.toml",
          "destination": "$ABS_PATH\\config\\vector\\vector.toml",
          "action": "copy"
        },
        {
          "source": "remap-site-logs.vrl",
          "destination": "$ABS_PATH\\config\\vector\\remap-site-logs.vrl",
          "action": "copy"
        },
        {
          "source": "docker-compose.vector.yml",
          "destination": "$ABS_PATH\\config\\docker-compose.vector.yml",
          "action": "copy"
        },
        {
          "source": "$ABS_PATH\\config\\docker-compose.vector.yml",
          "action": "replaceParameters"
        },
        {
          "source": "powershell -Command [System.IO.Directory]::CreateDirectory('$ABS_PATH/logs')",
          "action": "execute"
        }
      ]
    },
    {
      "name": "Drex-Message",
      "files": [
        {
          "type": "release",
          "source": "https://github.com/abs-wavesight/cc-drex/releases/download/$DREX_MESSAGE_RELEASE_TAG/",
          "destination": "c:/abs/temp/Drex-Message/"
        }
      ],
      "actions": [
        {
          "source": "drex-message.tar",
          "action": "install"
        },
        {
          "source": "..\\AdditionalFiles\\site-config.json",
          "destination": "$ABS_PATH\\config\\drex-shared\\",
          "action": "copy"
        },
        {
          "source": "..\\AdditionalFiles\\*.client-app-config.json",
          "destination": "$ABS_PATH\\config\\drex-shared\\",
          "action": "copy"
        },
        {
          "source": "docker-compose.drex-message.yml",
          "destination": "$ABS_PATH\\config\\docker-compose.drex-message.yml",
          "action": "copy"
        },
        {
          "source": "$ABS_PATH\\config\\docker-compose.drex-message.yml",
          "action": "replaceParameters"
        }
      ]
    },
    {
      "name": "Drex-File",
      "files": [
        {
          "type": "release",
          "source": "https://github.com/abs-wavesight/cc-drex/releases/download/$DREX_FILE_RELEASE_TAG/",
          "destination": "c:/abs/temp/Drex-File/"
        }
      ],
      "actions": [
        {
          "source": "drex-file.tar",
          "action": "install"
        },
        {
          "source": "docker-compose.drex-file.yml",
          "destination": "$ABS_PATH\\config\\docker-compose.drex-file.yml",
          "action": "copy"
        },
        {
          "source": "$ABS_PATH\\config\\docker-compose.drex-file.yml",
          "action": "replaceParameters"
        },
        {
          "source": "powershell -Command [System.IO.Directory]::CreateDirectory('$FDZ_ROOT_PATH')",
          "action": "execute"
        }
      ]
    },
    {
      "name": "OpenSsh",
      "files": [
        {
          "type": "release",
          "source": "https://github.com/abs-wavesight/cc-platform/releases/download/$OPENSSH_RELEASE_TAG/",
          "destination": "c:/abs/temp/OpenSsh/"
        }
      ],
      "actions": [
        {
          "source": "openssh.tar",
          "action": "install"
        },
        {
          "source": "docker-compose.openssh.yml",
          "destination": "$ABS_PATH\\config\\docker-compose.openssh.yml",
          "action": "copy"
        },
        {
          "source": "$ABS_PATH\\config\\docker-compose.openssh.yml",
          "action": "replaceParameters"
        },
        {
          "source": "config.json",
          "destination": "$ABS_PATH\\config\\openssh\\config.json",
          "action": "copy"
        },
        {
          "source": "$ABS_PATH\\config\\openssh\\config.json",
          "action": "replaceParameters"
        },		
        {
          "source": "sshd.config",
          "destination": "$ABS_PATH\\config\\openssh\\sshd.config",
          "action": "copy"
        },
        {
          "source": "create-ssh-keys-and-fingerprint.ps1",
          "destination": "$ABS_PATH\\config\\openssh\\create-ssh-keys-and-fingerprint.ps1",
          "action": "copy"
        },
        {
          "source": "$ABS_PATH\\config\\openssh\\sshd.config",
          "action": "replaceParameters"
        },			
        {
          "source": "powershell -Command [System.IO.Directory]::CreateDirectory('$OPENSSH_ROOT')",
          "action": "execute"
        },
        {
          "source": "powershell ./create-ssh-keys-and-fingerprint.ps1 '$ABS_PATH\\ssh-keys'",
          "action": "execute"
        }
      ]
    }
  ]
}
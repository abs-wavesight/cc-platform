{
  "location": "c:\\abs\\installer",
  "components": [
    {
      "name": "Docker",
      "files": [
        {
          "type": "file",
          "source": "https://download.docker.com/win/static/stable/x86_64/docker-24.0.4.zip",
          "destination": "docker.zip"
        },
        {
          "type": "file",
          "source": "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-windows-x86_64.exe",
          "destination": "docker-compose.exe"
        },
        {
          "type": "file",
          "source": "https://raw.githubusercontent.com/abs-wavesight/cc-platform/feature/ADO-20439-installer-install/compose/installer/docker-compose.root.yml",
          "destination": "docker-compose.root.yml"
        }
      ],
      "actions": [
        {
          "source": "net stop docker",
          "action": "executeImmediate"
        },		
        {
          "source": "tar -xf docker.zip -C c:\\docker",
          "action": "executeImmediate"
        },
        {
          "source": "docker-compose.exe",
          "destination": "c:\\docker\\docker-compose.exe",
          "action": "copy"
        },					
        {
          "source": "c:\\docker\\dockerd --service-name dockerd --register-service",
          "action": "executeImmediate"
        },
        {
          "source": "net start dockerd",
          "action": "executeImmediate"
        },
		{
          "source": "powershell -Command \"docker stop $(docker ps -a -q)\"",
          "action": "executeImmediate"
        },			
		{
          "source": "powershell -Command \"docker rm $(docker ps -a -q)\"",
          "action": "executeImmediate"
        },					
		{
          "source": "c:\\docker\\docker system prune -f",
          "action": "executeImmediate"
        },		
        {
          "source": "c:\\docker\\docker volume prune -f",
          "action": "executeImmediate"
        },				
        {
          "source": "c:\\docker\\docker network prune -f",
          "action": "executeImmediate"
        },
        {
          "source": "c:\\docker",
          "action": "updatePath"
        },		
        {
          "source": "docker-compose.root.yml",
          "destination": "c:\\config\\docker-compose.root.yml",
          "action": "copy"
        },
		{
          "source": "c:\\config\\docker-compose.root.yml",
          "action": "replaceParameters"
        },			
		{
          "source": "c:/config",
          "action": "runDockerCompose"
        }
      ]
    },
    {
      "name": "RabbitMq",
      "files": [
        {
          "type": "container",
          "source": "ghcr.io/abs-wavesight/rabbitmq:windows-$WINDOWS_VERSION",
          "destination": "rabbitmq.tar"
        },
        {
          "type": "file",
          "source": "https://raw.githubusercontent.com/abs-wavesight/cc-platform/feature/ADO-20439-installer-install/compose/installer/docker-compose.rabbitmq.yml",
          "destination": "docker-compose.rabbitmq.yml"
        },
        {
          "type": "file",
          "source": "https://raw.githubusercontent.com/abs-wavesight/cc-drex/main/config/rabbitmq/cc-rabbitmq.conf",
          "destination": "cc-rabbitmq.conf"
        }
      ],
      "actions": [
        {
          "source": "rabbitmq.tar",
          "action": "install"
        },
        {
          "source": "cc-rabbitmq.conf",
          "destination": "c:\\config\\rabbitmq\\cc-rabbitmq.conf",
          "action": "copy"
        },
        {
          "source": "docker-compose.rabbitmq.yml",
          "destination": "c:\\config\\docker-compose.rabbitmq.yml",
          "action": "copy"
        },
		{
          "source": "c:\\config\\docker-compose.rabbitmq.yml",
          "action": "replaceParameters"
        }
      ]
    },
    {
      "name": "Vector",
      "files": [
        {
          "type": "container",
          "source": "ghcr.io/abs-wavesight/vector:windows-$WINDOWS_VERSION",
          "destination": "vector.tar"
        },
        {
          "type": "file",
          "source": "https://raw.githubusercontent.com/abs-wavesight/cc-platform/feature/ADO-20439-installer-install/compose/installer/docker-compose.vector.yml",
          "destination": "docker-compose.vector.yml"
        },
        {
          "type": "file",
          "source": "https://raw.githubusercontent.com/abs-wavesight/cc-drex/main/config/vector/config/vector.toml",
          "destination": "vector.toml"
        }
      ],
      "actions": [
        {
          "source": "vector.tar",
          "action": "install"
        },
        {
          "source": "vector.toml",
          "destination": "c:\\config\\vector\\vector.toml",
          "action": "copy"
        },
        {
          "source": "docker-compose.vector.yml",
          "destination": "c:\\config\\docker-compose.vector.yml",
          "action": "copy"
        },
        {
          "source": "c:\\config\\docker-compose.vector.yml",
          "action": "replaceParameters"
        },
        {
          "source": "mkdir c:\\logs",          
          "action": "execute"
        }
      ]
    },
    {
      "name": "Drex",
      "files": [
        {
          "type": "container",
          "source": "ghcr.io/abs-wavesight/cc-drex-service:windows-$WINDOWS_VERSION",
          "destination": "drex.tar"
        },
        {
          "type": "file",
          "source": "https://raw.githubusercontent.com/abs-wavesight/cc-platform/feature/ADO-20439-installer-install/compose/installer/docker-compose.drex.yml",
          "destination": "docker-compose.drex.yml"
        }
      ],
      "actions": [
        {
          "source": "drex.tar",
          "action": "install"
        },
        {
          "source": "..\\AdditionalFiles\\site-config.json",
          "destination": "c:\\config\\drex\\site-config.json",
          "action": "copy"
        },
        {
          "source": "..\\AdditionalFiles\\client-config.json",
          "destination": "c:\\config\\drex\\client-config.json",
          "action": "copy"
        },
        {
          "source": "docker-compose.drex.yml",
          "destination": "c:\\config\\docker-compose.drex.yml",
          "action": "copy"
        },
		{
          "source": "c:\\config\\docker-compose.drex.yml",
          "action": "replaceParameters"
        }
      ]
    }
  ]
}
